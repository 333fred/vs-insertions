@inject RepoStateManager repoStateManager

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge">
    @if (SelectedVsBranch != null)
    {
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Last Insertion Status: @SelectedVsBranch</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                @if (!lastInsertionDetails.TryGetValue(SelectedVsBranch, out var details))
                {
                    <MudText Typo="Typo.body1">Loading...</MudText>
                }
                else
                {
                    <MudLink Typo="Typo.body1" Href="@details.Url" target="_blank">Link</MudLink>
                    <MudText Typo="Typo.body1">Commit: @details.Commit</MudText>
                    <MudText Typo="Typo.body1">Date: @details.Date</MudText>
                    <MudText Typo="Typo.body1">Comment: @details.Comment</MudText>
                }
            </MudCardContent>
        </MudCard>

        @if (vsInsertionsByBranch.TryGetValue(SelectedVsBranch, out var insertions))
        {
            @foreach (var insertion in insertions)
            {
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Insertion: @insertion.Title</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                    </MudCardContent>
                </MudCard>
            }
        }
        else
        {
            <MudText Typo="Typo.body1">Loading insertions...</MudText>
        }
    }
</MudContainer>

@code {
    [Parameter]
    public string? SelectedVsBranch { get; set; }

    [Parameter]
    public EventCallback<string?> SelectedVsBranchChanged { get; set; }

    [Parameter]
    public string? SelectedRepo { get; set; }
    [Parameter]
    public EventCallback<string?> SelectedRepoChanged { get; set; }

    readonly Dictionary<string, CommitDetails> lastInsertionDetails = new();
    readonly Dictionary<string, ImmutableArray<VsInsertion>> vsInsertionsByBranch = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var stateChanged = false;

        if (SelectedVsBranch != null && !lastInsertionDetails.ContainsKey(SelectedVsBranch))
        {
            await LoadLastInsertionDetailsAsync(SelectedVsBranch);
            stateChanged = true;
        }

        if (SelectedVsBranch != null && !vsInsertionsByBranch.ContainsKey(SelectedVsBranch))
        {
            var vsInsertions = await repoStateManager.GetInsertionsAsync(SelectedVsBranch, StatusFilter.Active, 0, "Roslyn");
            vsInsertionsByBranch.Add(SelectedVsBranch, vsInsertions);
            stateChanged = true;
        }

        if (stateChanged)
            StateHasChanged();
    }

    private async Task LoadLastInsertionDetailsAsync(string vsBranch)
    {
        var lastInsertionDetails = await repoStateManager.GetLastDetailsForRepo("Roslyn", vsBranch);
        if (lastInsertionDetails is { } details)
            this.lastInsertionDetails.Add(vsBranch, details);
        else
            this.lastInsertionDetails.Add(vsBranch, new CommitDetails("Unknown", DateTimeOffset.MinValue, "Unknown", ""));
    }
}
